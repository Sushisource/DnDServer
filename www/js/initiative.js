// Generated by CoffeeScript 1.3.1
(function() {
  var $j, add_char, addchar, addchar_form, addmodal, change_init, charname_input, del_char, init_initlist, initadd, initiative_input, initiativelist, sort_initlist, upd_char, well;

  $j = jQuery;

  initadd = $j('#init_add');

  addmodal = $j('#addchar');

  addchar = $j('#addchar_add');

  addchar_form = $j('#addchar_form');

  charname_input = $j('#charname');

  initiative_input = $j('#initiative');

  initiativelist = $j('#initiativelist');

  well = $j('#initlistwell');

  $j(function() {
    well.show();
    window.ws.send("get_state()");
    initadd.click(function() {
      charname_input.val("");
      initiative_input.val("");
      addmodal.on('shown', function() {
        return charname_input.focus().select();
      });
      return addmodal.modal('toggle');
    });
    addmodal.modal({
      keyboard: false,
      show: false
    });
    $j('#addchar input').bind('keypress', function(e) {
      if ((e.keyCode || e.which) === 13) {
        return addchar_form.submit();
      }
    });
    addchar.click(function() {
      return addchar_form.submit();
    });
    return addchar_form.submit(function() {
      var initv, name;
      name = charname_input.val().trim();
      initv = initiative_input.val();
      if (isNaN(initv) || initv === null || initv === "") {
        alert("Initiative must be a number");
        return false;
      }
      window.ws.send("add_char('" + name + "'," + initv + ")");
      addmodal.modal('toggle');
      return false;
    });
  });

  sort_initlist = function() {
    var listitems;
    listitems = initiativelist.children('.initchar').get();
    listitems.sort(function(ia, ib) {
      var a, b;
      a = parseInt($j($j(ia).find('.badge')[0]).html());
      b = parseInt($j($j(ib).find('.badge')[0]).html());
      if (a > b) {
        return 1;
      } else if (a < b) {
        return -1;
      } else {
        return 0;
      }
    });
    return $j.each(listitems, function() {
      return initiativelist.append(listitems);
    });
  };

  add_char = function(char) {
    var item;
    item = "<li id='" + char.id + "' class='hide initchar'><div class='pull-right' style='margin-top:5px;'>";
    item += "<a class='badge badge-inverse' id='init_" + char.id + "'>" + char.init + "</a>";
    item += "<a id='init_del_" + char.id + "' class='btn' href=#\n  style='padding:2px; height:15px; width:15px; margin:0 5px;'>\n  <i class='icon-trash'></i>\n</a></div>";
    item += "<a href='#'>" + char.name + "</a></li>";
    initiativelist.append(item).children(':last').fadeIn(200);
    $j("#init_del_" + char.id).click(function() {
      return window.ws.send("del_char('" + char.name + "')");
    });
    $j("#init_" + char.id).click(function() {
      return change_init(char);
    });
    return sort_initlist();
  };

  upd_char = function(char) {
    $j("#init_" + char.id).html(char.init);
    return sort_initlist();
  };

  del_char = function(char) {
    return $j("#" + char.id).fadeOut(function() {
      return $j("#" + char.id).remove();
    });
  };

  change_init = function(char) {
    charname_input.val(char.name);
    initiative_input.val($j("#init_" + char.id).html());
    addmodal.on('shown', function() {
      return initiative_input.focus().select();
    });
    return addmodal.modal('toggle');
  };

  init_initlist = function(chars) {
    var char, charobj, _results;
    initiativelist.children('.initchar').remove();
    _results = [];
    for (char in chars) {
      charobj = chars[char];
      _results.push(add_char(charobj));
    }
    return _results;
  };

  $j.dnd.callbacks['initlist'] = init_initlist;

  $j.dnd.callbacks['addchar'] = add_char;

  $j.dnd.callbacks['updatechar'] = upd_char;

  $j.dnd.callbacks['delchar'] = del_char;

}).call(this);
